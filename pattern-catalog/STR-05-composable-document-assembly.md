# Composable Document Assembly

**Category**: Structure
**Necessity**: Recommended

## Problem

How to generate long documents that exceed AI context window limits?

Long reports (such as research reports of tens of thousands of words) cannot be fully generated in a single AI call. Even if they can be generated, quality degrades as length increases. A common mistake is to have the AI generate the entire document "in one go," which either fails by exceeding context limits or results in severely degraded quality in the latter sections.

## Context

This pattern applies to the following scenarios:

- The final output is a long document (report, paper, manual, etc.)
- The document has a clear chapter structure
- Conversion to other formats is needed (such as generating PDF via pandoc)
- Format consistency is required

## Forces

- **Completeness vs Context Limits**: Long documents exceed AI processing capabilities
- **Quality vs Length**: The longer the single generation, the worse the quality of the latter sections
- **Independent Generation vs Format Consistency**: Segmented generation easily leads to inconsistent formatting
- **Flexibility vs Specification**: Overly strict specifications constrain expression; overly loose specifications cause assembly errors

## Solution

**Split long documents into independent sections, each section generated by an independent subagent, following strict format specifications, and finally mechanically assembled using scripts. The complete document never enters the AI context.**

### Core Principles

1. **Generate Sections Independently**
   - Each section is an independent subagent task
   - Follow [Faithful Agent Instantiation](./BHV-02-faithful-agent-instantiation.md), invoke independently for each section
   - Sections do not need the AI to "remember" previous content

2. **Strict Format Specifications**
   - All sections follow the same format specifications
   - Specifications must be specific and checkable, not vague "pay attention to format"
   - Specifications should consider downstream tool requirements (such as pandoc)

3. **Mechanical Assembly**
   - Assemble using shell scripts, not through AI
   - Assembly logic is simple and reliable: `cat` each section file
   - The complete document never needs to enter the AI context

4. **Reusable Format Specifications**
   - Format specifications as independent files, referenced by each section Blueprint
   - Modifying specifications requires changing only one place

## Consequences

### Benefits

- **Overcome Context Limits**: Documents of any length can be generated
- **Consistent Quality**: Each section receives sufficient "attention"
- **Parallelizable**: Multiple sections can be generated in parallel
- **Easy to Modify**: Only need to regenerate problematic sections
- **Reliable Format**: Assembled document has correct formatting

### Liabilities

- **Requires Pre-planning Structure**: Must determine section division in advance
- **Format Specification Maintenance**: Need to establish and maintain detailed specifications
- **Limited Flexibility**: Cross-references between sections require additional handling

## Implementation Guidelines

### Directory Structure

```
workspace/
├── 04.sections/              # Independent files for each section
│   ├── 00.frontmatter.md     # Cover, abstract, etc.
│   ├── 01.introduction.md
│   ├── 02.chapter1.md
│   ├── 03.chapter2.md
│   └── ...
├── 05.report/
│   └── full_report.md        # Assembled complete report
└── scripts/
    └── assemble.sh           # Assembly script
```

### Markdown Format Specification

Each section must follow **[Pandoc-Ready Markdown Format](./STR-08-pandoc-ready-markdown.md)** to ensure correct assembly and conversion.

Key points for section generation:
- Sections start with level-2 headings (##), not level-1
- Level-1 heading is reserved for the document title (in frontmatter only)
- Blank lines around all block elements (headings, lists, code blocks, tables)
- One blank line at beginning and end of each section file

See the full specification in the referenced pattern.

### Assembly Script Example

```bash
#!/bin/bash
# assemble.sh - Assemble sections into complete report

OUTPUT_DIR="workspace/05.report"
SECTIONS_DIR="workspace/04.sections"
OUTPUT_FILE="$OUTPUT_DIR/full_report.md"

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Clear or create output file
> "$OUTPUT_FILE"

# Assemble sections in order
for section in "$SECTIONS_DIR"/*.md; do
    if [ -f "$section" ]; then
        cat "$section" >> "$OUTPUT_FILE"
        # Ensure blank line between sections
        echo "" >> "$OUTPUT_FILE"
    fi
done

echo "Report generated: $OUTPUT_FILE"
```

### Section Generation Agent Blueprint Example

```markdown
# Section Writer Agent

## Your Task

Generate specified sections for the research report.

## Input

- Section number and title
- Analysis materials to be covered in this section (from workspace/03.analysis/)
- Format specification (see references/markdown-format-spec.md)

## Output

Write the generated section to `workspace/04.sections/{section_number}.{section_name}.md`

## Format Requirements

**Strictly follow all specifications in `references/markdown-format-spec.md`.**

Pay special attention to:
1. Sections start with level-2 headings (##)
2. One blank line at the beginning and end of the file
3. Blank lines before and after all lists
4. Do not use level-1 headings

## Quality Standards

- Content fully covers the specified analysis materials
- Clear exposition, logical coherence
- Accurate citations, labeled with source numbers
```

### Invocation Method in Orchestrator

```markdown
## Stage Four: Report Generation

### 4.1 Determine Section Structure

Based on analysis results, determine the section division of the report:
- 00.frontmatter.md: Cover, abstract
- 01.introduction.md: Introduction
- 02.xxx.md: Chapter 1
- ...

### 4.2 Generate Each Section

For each section, launch an independent subagent:

> Please read `agents/04.section_writer.md` and execute strictly according to that Blueprint.
>
> Parameters:
> - SECTION_ID: 02
> - SECTION_TITLE: xxx
> - SOURCE_MATERIALS: workspace/03.analysis/xxx.md

**Important**:
- Launch independent subagent for each section
- Can generate in parallel to improve efficiency
- Each subagent must read the format specification

### 4.3 Assemble Report

After all sections are generated, run the assembly script:

```bash
bash workspace/scripts/assemble.sh
```

### 4.4 Format Check

After assembly, check the format of the complete report:
- Are heading levels correct
- Are there any format errors
- Try converting with pandoc, check for warnings
```

## Examples

### Correct Example: Section Format

```markdown

## Policy Support System for the New Energy Vehicle Industry

This chapter analyzes the policy support system in the development of the new energy vehicle industry...

### Industrial Policies at the Central Level

According to materials in [SRC-012], the "Ten Cities, Thousand Vehicles" program was launched in 2009...

Policy instruments mainly include:

- Purchase subsidies
- Tax incentives
- License plate conveniences

### Local Supporting Policies

Local governments actively respond to central policies...

```

Notes:
- Starts with level-2 heading
- Blank line at the beginning
- Blank lines before and after lists
- Blank line at the end

### Error Example: Common Format Issues

```markdown
# Policy Support System for the New Energy Vehicle Industry    ❌ Used level-1 heading

This chapter analyzes the development of the new energy vehicle industry...
Policy instruments mainly include:               ❌ No blank line before list
- Purchase subsidies
- Tax incentives
Local governments actively respond...            ❌ No blank line after list
```

### Troubleshooting After Assembly

| Issue | Possible Cause | Solution |
|----------|----------|----------|
| Heading level confusion | A section used level-1 heading | Check and correct that section |
| List displayed as plain text | No blank line before list | Add blank line before list |
| No separation between sections | No blank line at end of section file | Check if assembly script adds blank lines |
| Pandoc conversion warnings | Special characters or format issues | Locate and fix according to warnings |

## Related Patterns

- **[Pandoc-Ready Markdown Format](./STR-08-pandoc-ready-markdown.md)**: Format specification for sections to ensure correct conversion
- **[Deliverable Export Pipeline](./STR-09-deliverable-export-pipeline.md)**: Exports assembled report to DOCX/PDF
- **[Faithful Agent Instantiation](./BHV-02-faithful-agent-instantiation.md)**: Independent subagent invocation for each section
- **[Filesystem Data Bus](./STR-02-filesystem-data-bus.md)**: Section files stored as intermediate artifacts
- **[Embedded Quality Standards](./QUA-01-embedded-quality-standards.md)**: Format specifications embedded in Blueprint
- **[Business-Driven Agent Design](./STR-04-business-driven-agent-design.md)**: Section generation as independent business step

## Checklist

When designing long document generation workflows, confirm the following:

- [ ] Has the document been split into independently generatable sections?
- [ ] Is there an independent format specification file?
- [ ] Is the format specification specific enough (checkable checklist)?
- [ ] Does the section generation Blueprint reference the format specification?
- [ ] Is there an assembly script?
- [ ] Does the assembly script handle blank lines between sections?
- [ ] Have downstream tool requirements (such as pandoc) been considered?
- [ ] Is there a format checking step?
