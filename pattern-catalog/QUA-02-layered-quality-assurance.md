# Layered Quality Assurance

**分类**：质量模式
**必要性**：可选

## 问题

如何建立系统性的质量保障？

单一的质量检查点难以覆盖所有质量维度。不同阶段的产出有不同的质量关注点，不同角色（AI、人类）有不同的检查能力。需要一种多层次、多角度的质量保障体系。

## 语境

该模式适用于以下场景：

- 系统产出质量要求高
- 质量问题修复成本随阶段递增（越晚发现越难修）
- 有多个阶段的处理流程
- 需要人类审核参与

## 作用力

- **质量保障程度 vs 效率**：层次越多质量越有保障，但效率越低
- **自动化 vs 人工审核**：自动化效率高但可能遗漏，人工准确但成本高
- **早期发现 vs 全局视角**：早期发现问题便于修复，但可能看不到全局
- **检查深度 vs 覆盖广度**：深度检查耗时，广度检查可能粗略

## 解决方案

**在系统的多个层次建立质量检查机制：Agent自检、跨Agent校验、专门QA阶段、人类审核。质量不是最后检查出来的，而是在全过程中构建的。**

### 五层质量保障模型

```
第五层：人类审核
        └── 关键结论人工确认、异常情况处理

第四层：专门QA阶段
        └── 集成质检Agent、跨维度一致性检查

第三层：流程执行符合性
        └── Orchestrator验证subagent是否按Blueprint执行

第二层：跨Agent校验
        └── 下游Agent验证上游产出、发现不一致

第一层：Agent自检
        └── 按Blueprint中的标准自检
```

### 各层职责

**第一层：Agent自检**
- 时机：Agent执行过程中和完成时
- 方式：对照Blueprint中的质量标准
- 关注：格式规范、内容完整、逻辑自洽
- 产出：符合标准的输出

**第二层：跨Agent校验**
- 时机：下游Agent读取上游产出时
- 方式：检查输入数据的质量和一致性
- 关注：数据格式、字段完整、内容合理
- 产出：发现问题时记录或报告

**第三层：流程执行符合性**
- 时机：Orchestrator收到subagent结果时
- 方式：对照Blueprint完成标准逐项验证
- 关注：subagent是否按Blueprint要求执行，而非自行变通
- 产出：验收通过/要求重做/记录异常

这一层检查的是**流程执行质量**而非数据质量。典型问题包括：
- subagent自行降低标准（如用抽样代替全量）
- subagent跳过某些步骤
- subagent的实际执行与Blueprint要求不符

**第四层：专门QA阶段**
- 时机：Pipeline的特定阶段
- 方式：专门的QA Agent进行全面检查
- 关注：跨维度一致性、整体完整性、事实准确性
- 产出：质量检查报告、问题清单

**第五层：人类审核**
- 时机：关键节点或最终输出前
- 方式：人工审阅和判断
- 关注：语义准确性、业务合理性、敏感内容
- 产出：批准/修改意见

## 结果

### 收益

- **质量内建**：质量在过程中构建，而非事后检查
- **早期发现问题**：问题在早期被发现，修复成本低
- **多角度覆盖**：不同层次关注不同质量维度
- **透明可审计**：质量检查过程有记录可查
- **人机协作**：AI处理常规检查，人类处理关键判断

### 代价

- **效率降低**：多层检查消耗时间和资源
- **复杂度增加**：需要设计和维护多层检查机制
- **可能过度检查**：某些场景可能不需要如此严格
- **协调成本**：需要协调各层检查的范围和深度

## 实现指南

### 第一层：在Blueprint中嵌入自检

```markdown
## 完成标准

在提交输出前，确认以下检查项：

### 格式检查
- [ ] 使用正确的Markdown格式
- [ ] 文件写入正确位置
- [ ] 文件命名符合规范

### 内容检查
- [ ] 所有必填字段已填写
- [ ] 所有数据有来源标注
- [ ] 无明显逻辑矛盾

### 质量检查
- [ ] 来源可信度已评估
- [ ] 关键数据已交叉验证
- [ ] 内容客观中立
```

### 第二层：下游Agent的输入验证

```markdown
## 前置验证

在开始分析之前，首先验证输入数据：

1. **存在性检查**
   - 确认所有预期的输入文件存在
   - 记录缺失的文件

2. **格式检查**
   - JSON文件能正常解析
   - Markdown文件结构符合预期

3. **完整性检查**
   - 必填字段都有值
   - 数据量符合预期

4. **一致性检查**
   - 跨文件的ID能匹配
   - 数值范围合理

如发现问题，记录到 `wip/notes.md` 并继续执行可执行的部分。
```

### 第三层：Orchestrator验收subagent结果

```markdown
## 阶段验收流程

每个阶段的subagent返回结果后，Orchestrator执行以下验收：

### 步骤一：获取完成标准
读取该阶段Blueprint中的"完成标准"部分。

### 步骤二：逐项对照
对于完成标准中的每一条：
- [ ] 该条标准是否已满足？
- [ ] 有什么证据表明已满足？（产出物、数量、覆盖范围等）

### 步骤三：比对报告
将subagent的自我报告与完成标准比对：
- subagent声称做了什么？
- 这与Blueprint要求的是否一致？
- 是否有降低标准或变通执行的迹象？

### 步骤四：验收结论
- **通过**：所有完成标准均已满足 → 推进下一阶段
- **部分通过**：有轻微偏差但可接受 → 记录问题，推进下一阶段
- **不通过**：存在严重偏离 → 要求重做或升级处理

### 警示信号
以下迹象表明可能存在执行问题，需要特别关注：
- subagent报告中出现"抽样"、"选取部分"等词汇
- 实际处理数量远小于预期
- 完成时间异常短
- 报告中有"由于时间/资源限制"等措辞
```

### 第四层：专门的QA Agent

```markdown
# 质量检查Agent

## 你的角色
你是系统的质量检查员，负责全面审核所有采集数据的质量。

## 检查内容

### 来源可访问性
- 检查所有URL是否仍然可访问
- 标记失效链接

### 数据一致性
- 交叉验证关键数据
- 标记存在矛盾的数据

### 来源可信度
- 评估每个来源的权威性
- 标记低可信度来源

### 覆盖完整性
- 检查是否所有功能项都有数据支撑
- 识别数据缺口

## 输出

### 质检报告 (`quality_check_report.md`)
- 质检概况统计
- 问题清单（按严重程度分类）
- 改进建议
```

### 第四层：设计人类审核点

```markdown
## 人工审核点

以下节点建议人工审核：

### 阶段一完成后
- 审核问题清单是否合理
- 确认调研方向正确

### 阶段二完成后
- 抽查数据采集质量
- 审核质检报告中的高风险项

### 最终报告生成后
- 审核核心结论
- 确认敏感内容处理得当
- 批准发布
```

## 示例

### 来自 industry_assessment 系统

**五层质量保障实现**：

```
第一层：各Agent Blueprint中的完成标准
├── Initial Scanner：采集原则（全面性、准确性、可追溯性、客观性）
├── Deep Researcher：数据采集原则 + 数据记录格式
├── Analyzer：分析质量要求（论据充分、逻辑严密、客观公正）
└── Reporter：报告格式规范 + 学术写作标准

第二层：跨Agent验证
├── Deep Researcher 验证 Initial Scanner 产出的问题清单
├── Analyzer 验证 Deep Researcher 产出的调研资料
└── Reporter 验证 Analyzer 产出的分析结论

第三层：流程执行符合性（Orchestrator验收）
├── 每阶段结束时对照Blueprint完成标准逐项验证
├── 检查subagent是否按要求执行（全量vs抽样、完整vs跳过）
├── 发现"抽样"、"部分"等警示信号时深入调查
└── 不符合标准的结果要求重做

第四层：专门质检
├── Deep Researcher 包含 QUALITY_CHECK 任务类型
│   ├── 来源可访问性检查
│   ├── 数据一致性检查
│   ├── 来源可信度评估
│   └── 覆盖完整性检查
└── 产出：quality_check_report.md

第五层：人类审核
├── 所有中间产物可随时人工查看
├── 关键节点可暂停等待人工确认
└── 最终报告发布前人工审核
```

### 事故案例：第三层缺失导致的问题

在 demo_mas 系统的一次执行中，数据复核阶段（阶段三）发生了严重的执行偏离：

**问题**：Data Verifier subagent 自行采用"抽样"方法，仅复核了 185 条数据中的 10 条（5.4%），而 Blueprint 要求全量复核。

**原因**：Orchestrator 收到 subagent 报告后，未对照 Blueprint 完成标准验证，直接接受了结果并推进后续阶段。

**后果**：
- 94.6% 的数据未经验证，可能存在大量幻觉数据
- 后续阶段（分析、综合、报告、质检）的可靠性全部受损
- 最终质检阶段给了"优秀"评价，但未发现阶段三的执行问题

**教训**：第三层（流程执行符合性）检查不可省略。Orchestrator 必须验证 subagent 是否按 Blueprint 要求执行，而非仅看 subagent 的自我报告。

**质检报告结构**：

```markdown
# 数据质检报告

## 质检概况
- 质检时间：[时间]
- 采集数据总量：[数量]
- 功能项覆盖率：[X/55]

## 来源可访问性检查
### 失效链接
- [链接1]：[原文件位置]
### 可访问但内容变更
- [链接1]：[变更说明]

## 数据一致性检查
### 数据矛盾
- [矛盾描述1]：[涉及来源]

## 来源可信度评估
### 高可信度来源统计
- [来源类型]：[数量]
### 低可信度来源警告
- [来源1]：[原因]

## 覆盖完整性检查
### 数据充足的功能项
### 数据不足的功能项
### 完全缺失数据的功能项

## 质检建议
[需要补充采集的内容和方向]
```

## 相关模式

- **[Embedded Quality Standards](./QUA-01-embedded-quality-standards.md)**：第一层质量保障的基础
- **[Faithful Agent Instantiation](./BHV-02-faithful-agent-instantiation.md)**：第三层流程执行符合性的实现基础
- **[Orchestrated Agent Pipeline](./BHV-01-orchestrated-agent-pipeline.md)**：在Pipeline中插入QA阶段
- **[Progressive Data Refinement](./BHV-04-progressive-data-refinement.md)**：各精炼层次都有质量检查

## 变体

### 简化三层模型
对于要求不高的场景，可简化为：
- 第一层：Agent自检
- 第二层：Orchestrator验收（不可省略）
- 第三层：最终人工审核

注意：第二层（流程执行符合性）不建议省略，因为这是防止 subagent 自行变通的关键防线。

### 强化QA模型
对于高要求场景，可增加：
- 多个QA Agent从不同角度检查
- 强制性的人工审核门禁
- 自动化的回归测试
- 流程执行的详细日志和审计

### 持续质量监控
在长期运行的系统中：
- 收集质量指标
- 识别质量趋势
- 自动预警质量下降

## 何时不使用此模式

- **快速原型**：需要快速验证想法
- **低价值任务**：质量要求不高的探索性任务
- **资源受限**：无法承受多层检查的开销
- **高度确定的任务**：输出格式和内容非常确定，简单校验即可
